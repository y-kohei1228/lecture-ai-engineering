# Day3宿題概要
この宿題では、講義で学んだRAG(Retrieval-Augmented Generation)技術を用いて、LLMの生成内容を改善する実践的な取り組みを行います。演習で利用したコードをベースに、独自の質問と参照文書を用いて実験を行い、RAGの効果を定量的・定性的に評価します。
この宿題を通じて、「テストデータの作成」と「改善のプロセス」について理解を深め、実際のアプリケーション開発に役立てることを目指します。

# Day3宿題の内容
## 独自の質問と参照資料の作成
### 自分で5つ以上の質問文を考案してください
### 各質問に対する回答を含む参照文書を用意してください
### 少なくとも1つは、LLMが単体では正確に答えられないような知識を含む質問にしてください

## 実験の実施
### 演習で使用したコードをベースに、以下の2つの方法で回答を生成してください
#### ベースのLLM(RAGなし)での回答生成
#### RAGを組み合わせた回答生成

### 回答の評価では、単純なYes/No判定でも良いです
#### より詳細な評価指標も検討していただけるとなお良いです

## 結果分析と考察
### 生成した結果をまとめ、RAGありとRAGなしの差異を分析してください
### RAGによって回答が改善したケースと悪化したケースの両方について考察してください
### 結果に基づいて、RAGの有効性と限界についての考察を記述してください

# Day3宿題の実施

## 独自の質問と参照文書の作成

### 独自の質問
1\. 「ジョブクラウンの社長は誰ですか？」

2\. 「ジョブクラウンの企業理念は何ですか？」

3\. 「入社初日に閲覧すべき社内規程やマニュアルはどこにありますか？」

4\. 「交通費と通勤費の違いを教えてください。」

5\. 「週報や日報で記載するべき内容を教えてください。」

### 質問設計の観点と意図
1\. 「ジョブクラウンの社長は誰ですか？」の質問設計の観点と意図
中小企業である株式会社ジョブクラウンの情報は、LLM単体では答えられないと考えられる。
RAG対象資料として、社員名簿を正しく参照し、そこから「CEO」の欄を正しく引くことができるか。

2\. 「ジョブクラウンの企業理念は何ですか？」の質問設計の観点と意図
中小企業である株式会社ジョブクラウンの情報は、LLM単体では答えられないと考えられる。
RAG対象資料として会社HPや規程類から正しい情報（事実）を引くことができるかどうか。

3\. 「入社初日に閲覧すべき社内規程やマニュアルのURLを教えてください」の質問設計の観点と意図
ジョブクラウンと記載されていないが、状況からジョブクラウンの社内規定とマニュアルのURLを求めている。
文脈からジョブクラウン内部の情報を求めていることを察し、適切な文書を探して、その文書を示すURLを示すことができるかどうか。

4\. 「交通費と通勤費の違いを教えてください。」の質問設計の観点と意図
ジョブクラウンの社内規程の中で最も理解が難しい（直感的に理解できない）立替精算における交通費と通勤費の違いを解説させたい。
backlogに掲載されている社内規定の文書の中から適切な文書を探し、その文書の中の交通費と通勤費のそれぞれの定義から、正しくその違いを解説できるかどうか。

5\. 「週報や日報で記載するべき内容を教えてください。」の質問設計の観点と意図
一般論で週報や日報で記載するべき内容を回答できるが、ここではそれを求めていない。
回答者はジョブクラウン社員であるので、当然に、ジョブクラウンの週報や日報のフォーマットに則った回答が優先される。
ジョブクラウンの週報や日報で記載するべき項目がそもそも規定されている。
過去の週報を読み取り、そのフォーマットから記載するべき内容を回答できるかどうか。


## 実験の実施
### ベースのLLM(RAGなし)での回答生成
1\. 「ジョブクラウンの社長は誰ですか？」のベースLLM（RAGなし）での回答生成
ジョブクラウンの社長は**藤井 浩**です。 \n\n\n\n

2\. 「ジョブクラウンの企業理念は何ですか？」のベースLLM（RAGなし）での回答生成
ジョブクラウンの企業理念は「**お客様の夢を叶える**」です。 \n\nこれは、企業が顧客のニーズを理解し、そのニーズに応えることで、お客様の夢を実現することを目指すことを表現しています。\n\n\n \n\n\n

3\. 「入社初日に閲覧すべき社内規程やマニュアルのURLを教えてください」のベースLLM（RAGなし）での回答生成
入社初日に閲覧すべき社内規程やマニュアルは、**会社によって異なります**。 \n\n一般的には、以下の場所から確認できます。\n\n* **人事部:**  入社時に人事担当者に相談して確認できます。\n* **会社 intranet:**  会社内にあるオンラインシステムで、社内規程やマニュアルが掲載されています。\n* **会社ホームページ:**  会社ホームページに、社内規程やマニュアルのリンクが掲載されている場合があります。\n* **入社説明会資料:**  入社説明会で配布された資料に、社内規程やマニュアルの項目が記載されている場合があります。\n* **部署の担当者:**  部署の担当者に直接問い合わせることもできます。\n\n\n \n\n\n \n\n\n

4\. 「交通費と通勤費の違いを教えてください。」のベースLLM（RAGなし）での回答生成

## 交通費と通勤費の違い\n\n**交通費**と**通勤費**はどちらも、**移動にかかる費用**ですが、**目的や範囲が異なります**。\n\n**交通費**は、**一般的に移動手段の利用費用**を指します。\n* **電車、バス、タクシー、飛行機、船**など、様々な手段で移動する際に支払う費用です。\n* **目的地や距離、利用頻度によって金額が異なります**。\n\n**通勤費**は、**仕事や学校に通うために必要な移動費用**を指します。\n* **主に自宅から職場や学校までの移動**を指します。\n* **交通手段や距離、通勤時間によって費用が異なります**。\n\n**簡単にまとめると:**\n\n* **交通費:**  一般的に移動手段の利用費用\n* **通勤費:**  仕事や学校に通うために必要な移動費用\n\n\n \n\n\n \n

5\. 「週報や日報で記載するべき内容を教えてください。」のベースLLM（RAGなし）での回答生成

## 週報や日報で記載すべき内容\n\n週報や日報は、チームの進捗状況や課題を明確に伝えるための重要なツールです。 \n内容を明確にすることで、チームメンバーとコミュニケーションを円滑に行い、より良い成果を上げるための基盤を築くことができます。\n\n**1. 週報/日報の基本的な構成**\n\n* **日付:**  週の始まりと終わりを明確に記載\n* **担当者:**  報告内容を担当する人の名前と所属\n* **プロジェクト名:**  報告内容が所属するプロジェクト名\n* **状況報告:**  週の進捗状況を簡潔に説明\n* **課題:**  課題や懸念事項を明確に記載\n* **目標:**  次の週の目標を明確に記載\n* **その他:**  その他必要な情報（例：会議の議題、進捗状況の補足情報）\n\n**2. 具体的な内容例**\n\n**A. 進捗状況**\n\n* **目標達成状況:**  目標達成状況を具体的に説明\n* **進捗状況:**  具体的な作業内容や進捗状況を記載\n* **課題:**  課題や懸念事項を明確に記載\n


### RAGを組み合わせた回答生成
1\. 「ジョブクラウンの社長は誰ですか？」のRAGを組み合わせた回答生成

ジョブクラウンの社長は記載されていません。


2\. 「ジョブクラウンの企業理念は何ですか？」のRAGを組み合わせた回答生成

参考資料からジョブクラウンの企業理念を特定することはできません。


3\. 「入社初日に閲覧すべき社内規程やマニュアルのURLを教えてください。」のRAGを組み合わせた回答生成

回答：参考資料には、入社初日に閲覧すべき社内規程やマニュアルの場所が記載されていません。

4\. 「交通費と通勤費の違いを教えてください。」のRAGを組み合わせた回答生成

## 交通費と通勤費の違い

**通勤費**は、自宅から現場までの交通費用です。

**交通費**は、自宅から現場以外の場所（例：現場～本社、自宅～面談先など）までの交通費用です。


5\. 「週報や日報で記載するべき内容を教えてください。」のRAGを組み合わせた回答生成

日報・週報のどちらで提出するべきかについては、**休日出勤の場合は備考欄へ代休日or残業計上いずれかを記載**、**代休の場合は備考欄へ休日出勤日を記載**します。 


### 回答の評価
1\. 「ジョブクラウンの社長は誰ですか？」の回答の評価

正しくは「反町好克」であるが、RAGの回答では「ジョブクラウンの社長は、記載されていません。」となった。
資料の中に社員リストがあり、そこに「CEO　反町好克」と記載がある。

2\. 「ジョブクラウンの企業理念は何ですか？」の回答の評価

RAGの回答では「参考資料からジョブクラウンの企業理念を特定することはできません。」とされている。
資料の中に企業理念について記載された文章は無かったので、「正解」とする。


3\. 「入社初日に閲覧すべき社内規程やマニュアルのURLを教えてください。」の回答の評価

RAGの回答では「回答：参考資料には、入社初日に閲覧すべき社内規程やマニュアルの場所が記載されていません。」であった。RAGの参照するテキストとしては、期待した結果ではなかった。

4\. 「交通費と通勤費の違いを教えてください。」の回答の評価

RAGの回答では「通勤費=自宅から現場までの移動費用」「交通費=自宅から現場以外の場所（例：現場～本社、自宅～面談先など）までの交通費用」となった。
期待した答えの通りであり「正解」。

5\. 「週報や日報で記載するべき内容を教えてください。」の回答の評価

RAGの回答では「日報・週報のどちらで提出するべきかについては、**休日出勤の場合は備考欄へ代休日or残業計上いずれかを記載**、**代休の場合は備考欄へ休日出勤日を記載**します。」が記載された。期待した答えではなく「不正解」。


## RAGの実装方法と工夫点

### 実装方法
RAG（Retrieval-Augmented Generation）の実装には、講義で使用したベースコードを応用しました。具体的には以下のステップで構成しています。

#### 参照文書の前処理
すべての参照文書をテキストファイルとして整理し、句点や改行位置に注意しながら自然な単位（段落など）で分割しました。

#### ベクトル化とインデックス作成
分割した文書を infly/inf-retriever-v1-1.5b を使って埋め込みベクトルに変換しました。

#### 検索とプロンプト生成
ユーザーの質問をベクトル化し、類似度検索で上位5件の参照セクションを取得。
検索結果をプロンプトテンプレートに埋め込み、google/gemma-2-2b-jpn-it に回答を生成させました。

### 工夫点

#### LLMの暴走抑止
参照資料にない内容を創作しないよう、プロンプトに「以下の文書の内容に基づいて、事実としてわかる範囲でのみ答えてください」と指示文を加えた。

## 結果の分析と考察
RAGではないベースLLMの回答では、一般論に逃げたり、嘘を付いたりするなどをした。
RAGにすることで、資料を根拠に回答するような「姿勢」をみせるようになった。
ただし、そのRAGにおいても、参照テキストを丁寧に分割するようなプログラムに改善しないと、期待した回答にはならないような模様。

## 発展的な改善案
1\. ベクトル検索の精度改善に向けた工夫
RAGの性能は、適切な文書を検索できるかどうかに大きく依存する。埋め込みモデル（例：text-embedding-ada-002やbge-m3など）の変更、ベクトルの正規化、検索アルゴリズムのチューニング（Top-kの調整など）を行い、どの条件が最も良い結果をもたらすかを比較検証する。

2\. コンテキスト文書の選択戦略の最適化
参照文書をそのまま使うのではなく、LLMに渡す文書の長さ制限を意識して、スコアに基づく文書の優先順位づけや文要約を導入することで、生成結果の質を高める方法を検討する。

3\. 質問タイプごとのパフォーマンス差分析
事実質問、手続き的質問、曖昧な質問など、質問の種類によってRAGの効果に差が出ることがある。各質問タイプに対するRAGの強み・弱みを分類し、今後の応用に向けた指針を整理する。

4\. 回答文の評価方法の多様化
単純な正誤評価に加え、「情報の正確性」「網羅性」「読みやすさ」「根拠提示の有無」など、複数軸での定性的評価指標を導入し、より深い分析を試みる。また、評価を複数人で実施し、主観の偏りを緩和する方法も考えられる。

5\. 社内特化型RAGシステムの提案
実験結果を踏まえ、ジョブクラウン社のような社内ナレッジが分散しやすい組織に向けた、社内文書管理・検索・回答生成を一体化させた「社内Q&A支援システム」の試作や設計案を提案する。

